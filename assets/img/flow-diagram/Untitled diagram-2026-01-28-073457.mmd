flowchart TD
    Start([Wazuh Agent<br/>Collects Security Event]) --> WazuhManager[Wazuh Manager<br/>Port 1514/1515]
    WazuhManager -->|Webhook POST<br/>X-API-Key Auth| Gateway[Integration Gateway<br/>Port 8002<br/>/webhook]
    
    Gateway --> CheckLevel{Check<br/>rule_level}
    
    CheckLevel -->|Level < 6| Archive[Archive<br/>No Processing]
    CheckLevel -->|Level 6-7| Dashboard1[Store to Dashboard<br/>Basic Logging]
    CheckLevel -->|Level 8-9| Level8Flow[Medium Severity<br/>Enrichment Path]
    CheckLevel -->|Level >= 10| Level10Flow[Critical Severity<br/>Full Enrichment Path]
    
    %% Level 8-9 Flow
    Level8Flow --> LLMTriage1[POST /analyze<br/>Alert Triage Service<br/>Port 8100]
    LLMTriage1 -->|Uses| Ollama1[Ollama LLM<br/>Port 11434<br/>Model: llama3.2:3b]
    Ollama1 --> TriageResult1{LLM Severity<br/>Assessment}
    
    TriageResult1 -->|Low/Medium| Dashboard2[Store to Dashboard<br/>No Further Action]
    TriageResult1 -->|High/Critical| Conditional[Conditional<br/>Enrichment]
    
    Conditional --> RAG1[POST /retrieve<br/>RAG Service<br/>Port 8001]
    RAG1 -->|Query| ChromaDB1[(ChromaDB<br/>Port 8000<br/>MITRE KB)]
    ChromaDB1 --> RAG1Result[Return MITRE<br/>Techniques]
    
    Conditional -->|If source_ip exists| ML1[POST /predict<br/>ML Inference Service<br/>Port 8500]
    ML1 -->|RandomForest<br/>99.28% Accuracy| ML1Result[Traffic Classification<br/>BENIGN/ATTACK]
    
    RAG1Result --> Dashboard3[Store Enriched Alert<br/>to Database]
    ML1Result --> Dashboard3
    
    %% Level 10+ Flow
    Level10Flow --> LLMTriage2[POST /analyze<br/>Alert Triage Service<br/>Port 8100]
    LLMTriage2 -->|Uses| Ollama2[Ollama LLM<br/>Port 11434]
    Ollama2 --> TriageResult2[Severity + IOCs<br/>Extracted]
    
    TriageResult2 --> RAG2[POST /retrieve<br/>RAG Service<br/>Port 8001]
    RAG2 -->|Query| ChromaDB2[(ChromaDB<br/>Port 8000<br/>835 Techniques)]
    ChromaDB2 --> RAG2Result[MITRE Context<br/>Detection Methods]
    
    RAG2Result -->|If source_ip exists| ML2[POST /predict<br/>ML Inference Service<br/>Port 8500]
    ML2 -->|77-dim Features<br/>3ms Latency| ML2Result[Behavioral Analysis<br/>Confidence Score]
    
    ML2Result --> FlagQueue[Flag for Investigation<br/>Queue Alert ID]
    FlagQueue --> Dashboard4[Store to Dashboard<br/>With Investigation Flag]
    
    %% Manual Investigation Trigger
    Dashboard4 -.->|Analyst Action| InvestigateBtn[Click Investigate Button<br/>on Dashboard]
    
    InvestigateBtn --> InvestigateAPI[POST /investigate/alert_id<br/>Integration Gateway<br/>Port 8002]
    
    InvestigateAPI --> RetrieveAlert[(Retrieve Alert<br/>from Database)]
    RetrieveAlert --> ExtractIP[Extract IP Address<br/>from Alert Data]
    ExtractIP --> CrewAIStart[CrewAI Kickoff<br/>Sequential Process]
    
    %% CrewAI Phase 1
    CrewAIStart --> Phase1[PHASE 1: COORDINATOR<br/>Execution Time: 5s]
    Phase1 --> Agent1[Agent 1:<br/>Threat Intelligence Coordinator]
    Agent1 -->|Task| ValidateIP[Validate IP Format<br/>Remove Duplicates<br/>Prepare Scope]
    ValidateIP --> Output1[Output: Valid IP List]
    
    %% CrewAI Phase 2
    Output1 --> Phase2[PHASE 2: EXTERNAL INTEL<br/>Execution Time: 15s<br/>Parallel Agents]
    
    Phase2 --> Agent2[Agent 2:<br/>VirusTotal Specialist]
    Agent2 -->|Tool Call| VTTool[VirusTotal IP Checker<br/>API: virustotal.com/v3]
    VTTool --> VTResult[Result: X/98 vendors<br/>Reputation Score<br/>Verdict]
    
    Phase2 --> Agent3[Agent 3:<br/>AbuseIPDB Analyst]
    Agent3 -->|Tool Call| AbuseTool[AbuseIPDB Checker<br/>API: abuseipdb.com/v2]
    AbuseTool --> AbuseResult[Result: Abuse Confidence %<br/>Country, ISP<br/>Total Reports]
    
    Phase2 --> Agent4[Agent 4:<br/>Internal Intel Analyst]
    Agent4 -->|Tool Call| YetiTool[Yeti Threat Intelligence<br/>Platform Query]
    YetiTool --> YetiResult[Result: Tags Found<br/>blocklist, malware, c2<br/>Verdict]
    
    Phase2 --> Agent5[Agent 5:<br/>SIEM Historical Analyst]
    Agent5 -->|Tool Call| SIEMTool[Query Wazuh DB<br/>SQLite: wazuh_alerts.db<br/>Last 30 Days]
    SIEMTool --> SIEMResult[Result: Alert Count<br/>Critical/Suspicious<br/>Timeline Data]
    
    VTResult --> Phase3Start
    AbuseResult --> Phase3Start
    YetiResult --> Phase3Start
    SIEMResult --> Phase3Start
    
    %% CrewAI Phase 3
    Phase3Start[Context Passed to Phase 3]
    Phase3Start --> Phase3[PHASE 3: AI ENRICHMENT<br/>Execution Time: 20s<br/>Parallel Agents]
    
    Phase3 --> Agent6[Agent 6:<br/>ML Classification Specialist]
    Agent6 -->|Tool Call| MLService[POST localhost:8500/predict<br/>ML Inference Service]
    MLService -->|RandomForest Model| MLOutput[Result: BENIGN/ATTACK<br/>Confidence 0-1<br/>Inference Time]
    
    Phase3 --> Agent7[Agent 7:<br/>Alert Triage Specialist]
    Agent7 -->|Tool Call| TriageService[POST localhost:8100/analyze<br/>Alert Triage Service]
    TriageService -->|Ollama LLM| TriageOutput[Result: Severity Level<br/>Key Indicators<br/>Priority]
    
    Phase3 --> Agent8[Agent 8:<br/>MITRE Framework Analyst]
    Agent8 -->|Tool Call| RAGService[POST localhost:8001/retrieve<br/>RAG Service]
    RAGService -->|ChromaDB Query<br/>Semantic Search| MITREOutput[Result: Technique IDs<br/>Tactics, Detection<br/>Mitigation]
    
    MLOutput --> Phase4Start
    TriageOutput --> Phase4Start
    MITREOutput --> Phase4Start
    
    %% CrewAI Phase 4
    Phase4Start[All Context Aggregated]
    Phase4Start --> Phase4[PHASE 4: CORRELATION<br/>Execution Time: 30s]
    
    Phase4 --> Agent9[Agent 9:<br/>Threat Correlation Analyst]
    Agent9 --> Correlate[Synthesize All Findings:<br/>External Intel<br/>AI Analysis<br/>Internal History]
    Correlate --> ThreatScore[Calculate Threat Score<br/>Weight Each Source<br/>Flag Discrepancies]
    ThreatScore --> Verdict[Final Verdict:<br/>CRITICAL/HIGH/MEDIUM/LOW/BENIGN<br/>Confidence Percentage]
    
    %% CrewAI Phase 5
    Verdict --> Phase5[PHASE 5: REPORT GENERATION<br/>Execution Time: 40s]
    Phase5 --> Agent10[Agent 10:<br/>Report Specialist]
    Agent10 --> BuildReport[Generate PDF Report:<br/>Executive Summary<br/>Technical Details<br/>Attack Timeline<br/>MITRE Techniques<br/>Recommendations]
    
    BuildReport --> SavePDF[Save to /reports/<br/>IOC_Report_IP_timestamp.pdf]
    SavePDF --> StoreDB[(Store Investigation Results<br/>Database)]
    StoreDB --> ReturnDashboard[Return Report Path<br/>to Dashboard]
    
    ReturnDashboard --> AnalystView[Analyst Views:<br/>Complete Investigation<br/>90-120 seconds total]
    
    %% Supporting Infrastructure
    subgraph Monitoring [Monitoring Layer]
        Prometheus[Prometheus<br/>Port 9090<br/>Metrics Collection]
        Loki[Loki<br/>Port 3100<br/>Log Aggregation]
        Grafana[Grafana<br/>Port 3000<br/>Visualization]
    end
    
    Gateway -.->|Exposes /metrics| Prometheus
    LLMTriage1 -.->|Logs| Loki
    RAG1 -.->|Logs| Loki
    ML1 -.->|Logs| Loki
    
    %% Network Architecture
    subgraph Networks [Docker Networks]
        AINet[ai-services<br/>172.30.0.0/24]
        MonNet[monitoring<br/>172.40.0.0/24]
    end
    
    LLMTriage1 -.->|Internal| AINet
    RAG1 -.->|Internal| AINet
    ML1 -.->|Internal| AINet
    Prometheus -.->|Internal| MonNet
    
    %% Styling
    classDef gatewayClass fill:#ff6b6b,stroke:#c92a2a,color:#fff,stroke-width:3px
    classDef serviceClass fill:#4ecdc4,stroke:#0a9396,color:#fff,stroke-width:2px
    classDef agentClass fill:#95e1d3,stroke:#38a3a5,color:#000,stroke-width:2px
    classDef phaseClass fill:#ffd93d,stroke:#f4a261,color:#000,stroke-width:3px
    classDef dbClass fill:#a8dadc,stroke:#457b9d,color:#000,stroke-width:2px
    classDef toolClass fill:#f4a261,stroke:#e76f51,color:#fff,stroke-width:2px
    classDef resultClass fill:#e9ecef,stroke:#6c757d,color:#000,stroke-width:1px
    
    class Gateway,InvestigateAPI gatewayClass
    class LLMTriage1,LLMTriage2,RAG1,RAG2,ML1,ML2,Ollama1,Ollama2,MLService,TriageService,RAGService serviceClass
    class Agent1,Agent2,Agent3,Agent4,Agent5,Agent6,Agent7,Agent8,Agent9,Agent10 agentClass
    class Phase1,Phase2,Phase3,Phase4,Phase5 phaseClass
    class StoreDB,ChromaDB1,ChromaDB2,RetrieveAlert dbClass
    class VTTool,AbuseTool,YetiTool,SIEMTool toolClass
    class VTResult,AbuseResult,YetiResult,SIEMResult,MLOutput,TriageOutput,MITREOutput resultClass