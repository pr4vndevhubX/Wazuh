# ============================================================================
# IP INTELLIGENCE CREW - TASK DEFINITIONS (UPDATED FOR MICROSERVICES)
# ============================================================================

task_coordinator:
  description: >
    You are receiving these specific IP addresses to investigate: {ip_address}
    
    Your responsibilities:
    1. Parse and validate the IP addresses from: {ip_address}
    2. Split comma-separated IPs into individual addresses
    3. Validate each IP format (IPv4: x.x.x.x or IPv6)
    4. Remove any duplicates from the list
    5. Prepare the validated IP list for analysis
    
    CRITICAL RULES:
    - ONLY analyze the IPs provided in {ip_address}
    - Do NOT add, substitute, or analyze any other IP addresses
    - Do NOT use example IPs or test IPs
    - If an IP is invalid, note it but continue with valid ones
    
    OUTPUT REQUIREMENTS:
    Provide a clear summary with:
    - Total number of IPs received
    - List of valid IPs to be analyzed
    - List of any invalid IPs (if present)
    - Confirmation that these IPs will be sent to specialized agents
    
  expected_output: >
    Coordination Report:
    
    RECEIVED IP ADDRESSES: {ip_address}
    
    VALIDATION RESULTS:
    - Total IPs Received: X
    - Valid IPs: [list each IP]
    - Invalid IPs: [list if any, or "None"]
    
    NEXT STEPS:
    These valid IPs will be analyzed by:
    - VirusTotal Reputation Specialist
    - AbuseIPDB Analyst  
    - Internal Threat Intelligence Analyst (Yeti)
    - SIEM Historical Analyst
    - ML Classification Specialist
    - Alert Triage Specialist
    - MITRE ATT&CK Analyst
    
    Proceeding with analysis...
  agent: coordinator_agent

# ============================================================================
# EXTERNAL THREAT INTELLIGENCE TASKS
# ============================================================================

task_virustotal_check:
  description: >
    Query VirusTotal API for each IP address provided by the coordinator.
    
    INSTRUCTIONS:
    1. Use the VirusTotal IP Checker tool for EACH IP from the coordinator
    2. Collect malicious vendor count (X/98 format)
    3. Record reputation scores
    4. Determine verdict (clean vs malicious)
    5. Note any vendor-specific detections
    
    REQUIREMENTS:
    - Check ALL IPs provided by the coordinator
    - Use the tool once per IP address
    - Report clear verdicts for each IP
    - Flag any IP with malicious detections > 0
    
  expected_output: >
    VirusTotal Analysis Results:
    
    IP: [IP Address]
    - Vendors Flagged: X/98
    - Reputation Score: XXX
    - Verdict: CLEAN/MALICIOUS
    - Details: [vendor names if malicious]
    
  agent: virustotal_agent
  context:
    - task_coordinator

task_abuseipdb_check:
  description: >
    Query AbuseIPDB for each IP address provided by the coordinator.
    
    INSTRUCTIONS:
    1. Use the AbuseIPDB Checker tool for EACH IP from the coordinator
    2. Collect abuse confidence scores (0-100%)
    3. Record total number of reports
    4. Capture ISP and country information
    5. Check whitelist status
    6. Determine verdict based on confidence score
    
    REQUIREMENTS:
    - Check ALL IPs provided by the coordinator
    - Consider confidence > 50% as HIGH RISK
    - Note whitelisted IPs (Google, Cloudflare, etc.)
    
  expected_output: >
    AbuseIPDB Analysis Results:
    
    IP: [IP Address]
    - Abuse Confidence: X%
    - Total Reports: XXX
    - ISP: [ISP Name]
    - Country: [CC]
    - Whitelisted: Yes/No
    - Verdict: CLEAN/SUSPICIOUS/ABUSIVE
    
  agent: abuseipdb_agent
  context:
    - task_coordinator

task_yeti_check:
  description: >
    Search internal Yeti threat intelligence platform for each IP address
    provided by the coordinator.
    
    INSTRUCTIONS:
    1. Use the Yeti Threat Intelligence tool for EACH IP from the coordinator
    2. Check if IP exists in Yeti database
    3. Collect all threat tags (blocklist, malware, c2, etc.)
    4. Note any historical context
    5. Determine threat level based on tags
    
  expected_output: >
    Yeti Threat Intelligence Results:
    
    IP: [IP Address]
    - Found in Yeti: Yes/No
    - Tags: [list tags or "N/A"]
    - Verdict: MALICIOUS/SUSPICIOUS/NOT_FOUND
    - Summary: [context if found]
    
  agent: yeti_agent
  context:
    - task_coordinator

# ============================================================================
# INTERNAL SIEM TASK
# ============================================================================

task_siem_query:
  description: >
    âš ï¸ CRITICAL: YOU MUST USE THE "Query Wazuh SIEM History" TOOL âš ï¸
    
    DO NOT GUESS OR MAKE UP DATA. ONLY REPORT WHAT THE TOOL RETURNS.
    
    MANDATORY EXECUTION STEPS:
    1. CALL THE TOOL: "Query Wazuh SIEM History"
    2. WAIT FOR TOOL RESPONSE
    3. REPORT EXACTLY WHAT TOOL RETURNED
    
    VERIFICATION CHECKLIST:
    - [ ] Did you call the tool?
    - [ ] Did you receive tool output with 'alerts_found' field?
    - [ ] Are you reporting exact counts (not estimates)?
    
  expected_output: >
    Wazuh SIEM Query Results:
    
    IP: [IP Address]
    - Alerts Found: [EXACT COUNT FROM TOOL]
    - CRITICAL: [COUNT] alerts
    - SUSPICIOUS: [COUNT] alerts
    - Timeline: First seen [DATE], Last seen [DATE]
    - Verdict: PREVIOUSLY_DETECTED / NEVER_SEEN
    
  agent: siem_agent
  context:
    - task_coordinator

# ============================================================================
# MICROSERVICE ENRICHMENT TASKS (NEW)
# ============================================================================

task_ml_classification:
  description: >
    Call ML Inference Service (port 8300) to classify network traffic behavior
    for IP address {ip_address}.
    
    INSTRUCTIONS:
    1. Use the "ML Classification Tool" with the IP address
    2. The tool calls http://localhost:8300/predict endpoint
    3. Parse the response:
       - prediction: (DDoS, PortScan, BruteForce, Botnet, Benign)
       - confidence: (0.0 to 1.0)
       - features_used: (packet_count, bytes_transferred, etc.)
    4. Report the classification result clearly
    
    HANDLING ERRORS:
    - If service is unavailable (connection error):
      â†’ Report: "ML Classification Service unavailable"
      â†’ Continue with other analysis (don't fail the entire investigation)
    - If IP has no traffic data:
      â†’ Report: "No traffic data available for ML classification"
    
    OUTPUT FORMAT:
    - IP Address: [IP]
    - ML Prediction: [DDoS/PortScan/BruteForce/Botnet/Benign]
    - Confidence Score: [0.XX] (XX%)
    - Verdict: ATTACK_DETECTED / NORMAL_TRAFFIC / UNKNOWN
    - Features Analyzed: [list key features]
    
  expected_output: >
    ML Traffic Classification Results:
    
    IP: [IP Address]
    - Prediction: [Attack Type or Benign]
    - Confidence: [XX%]
    - Verdict: ATTACK_DETECTED / NORMAL_TRAFFIC / UNKNOWN
    - Analysis: [Brief explanation of classification]
    
    OR if service unavailable:
    ML Classification Service unavailable - continuing with other sources
    
  agent: ml_classifier_agent
  context:
    - task_coordinator

task_alert_triage:
  description: >
    Call Alert Triage Service (port 8100) to perform LLM-based analysis
    on alerts related to IP address {ip_address}.
    
    INSTRUCTIONS:
    1. Use the "Alert Triage Tool" with alert data
    2. The tool calls http://localhost:8100/triage endpoint
    3. Parse the response:
       - severity: (critical, high, medium, low)
       - confidence: (0.0 to 1.0)
       - key_indicators: (list of IOCs extracted)
       - recommended_priority: (urgent, high, normal, low)
       - reasoning: (LLM explanation)
    4. Report the triage assessment clearly
    
    HANDLING ERRORS:
    - If service is unavailable:
      â†’ Report: "Alert Triage Service unavailable"
      â†’ Continue with other analysis
    - If no alerts exist for the IP:
      â†’ Report: "No alerts to triage for this IP"
    
    OUTPUT FORMAT:
    - IP Address: [IP]
    - Severity Assessment: [critical/high/medium/low]
    - Confidence: [XX%]
    - Key Indicators: [list IOCs]
    - Priority: [urgent/high/normal/low]
    - LLM Analysis: [reasoning]
    
  expected_output: >
    Alert Triage Analysis Results:
    
    IP: [IP Address]
    - Severity: [critical/high/medium/low]
    - Confidence: [XX%]
    - Key Indicators: [IOC list]
    - Recommended Priority: [urgent/high/normal/low]
    - Analysis: [LLM reasoning]
    
    OR if service unavailable:
    Alert Triage Service unavailable - continuing with other sources
    
  agent: alert_triage_agent
  context:
    - task_coordinator
    - task_siem_query

task_mitre_context:
  description: >
    Call RAG Service (port 8200) to retrieve MITRE ATT&CK context for
    threats associated with IP {ip_address}.
    
    INSTRUCTIONS:
    1. Use the "MITRE ATT&CK RAG Tool" with query based on:
       - Alert descriptions (if available)
       - Observed behaviors (from VirusTotal/AbuseIPDB)
       - ML predictions (if attack detected)
    2. The tool calls http://localhost:8200/query endpoint
    3. Parse the response:
       - techniques: [list of MITRE technique IDs]
       - tactics: [list of MITRE tactics]
       - descriptions: [technique descriptions]
       - detection_methods: [how to detect]
       - mitigation: [recommended defenses]
    4. Report relevant MITRE context
    
    QUERY CONSTRUCTION:
    - If SIEM has SSH brute force alerts:
      â†’ Query: "SSH brute force attack techniques"
    - If ML detects DDoS:
      â†’ Query: "DDoS attack techniques and tactics"
    - If VirusTotal shows malware:
      â†’ Query: "Malware delivery and C2 techniques"
    
    HANDLING ERRORS:
    - If service is unavailable:
      â†’ Report: "MITRE ATT&CK Service unavailable"
      â†’ Continue with other analysis
    
    OUTPUT FORMAT:
    - IP Address: [IP]
    - Relevant Techniques: [T1XXX: Technique Name]
    - Associated Tactics: [TA00XX: Tactic Name]
    - Detection Methods: [How to detect this technique]
    - Recommended Mitigations: [Defensive measures]
    
  expected_output: >
    MITRE ATT&CK Context:
    
    IP: [IP Address]
    - Techniques Detected:
      - T1XXX: [Technique Name] - [Description]
      - T1YYY: [Technique Name] - [Description]
    - Tactics: [TA00XX: Tactic names]
    - Detection: [Methods to detect these techniques]
    - Mitigation: [Recommended defenses]
    
    OR if service unavailable:
    MITRE ATT&CK Service unavailable - continuing with other sources
    
  agent: mitre_context_agent
  context:
    - task_coordinator
    - task_siem_query
    - task_ml_classification
    - task_alert_triage

# ============================================================================
# CORRELATION & REPORTING TASKS (UPDATED)
# ============================================================================

task_correlation_analysis:
  description: >
    Correlate findings from ALL sources to determine overall threat level
    for EACH IP address analyzed.
    
    SOURCES TO CORRELATE:
    1. External Threat Intel:
       - VirusTotal (vendor detections)
       - AbuseIPDB (abuse confidence)
       - Yeti (internal history)
    
    2. Enrichment Services:
       - ML Classification (behavioral patterns)
       - Alert Triage (LLM severity assessment)
       - MITRE ATT&CK (standardized techniques)
    
    3. Internal Activity:
       - Wazuh SIEM (historical alerts)
    
    ENHANCED CLASSIFICATION FRAMEWORK:
    
    ğŸ”´ CRITICAL - Immediate Action Required:
    - Yeti tags: 'malware', 'c2', 'ransomware', 'apt'
    - VirusTotal: > 5 vendors flagged
    - AbuseIPDB: > 75% confidence
    - ML: High confidence attack prediction
    - LLM Triage: Critical severity
    - SIEM: Active compromise indicators
    - MITRE: Techniques mapped to active campaign
    
    ğŸŸ  HIGH - Close Monitoring Required:
    - VirusTotal: 1-4 vendors flagged
    - AbuseIPDB: 50-75% confidence
    - ML: Medium confidence attack
    - LLM Triage: High severity
    - SIEM: Suspicious activity
    - MITRE: Known attack techniques detected
    
    ğŸŸ¡ MEDIUM - Worth Monitoring:
    - VirusTotal: Suspicious detections
    - AbuseIPDB: 25-49% confidence
    - ML: Low confidence anomaly
    - LLM Triage: Medium severity
    - SIEM: Few alerts
    - MITRE: Generic techniques
    
    ğŸŸ¢ LOW - Minimal Risk:
    - Clean across external sources
    - ML: Benign traffic
    - No SIEM alerts
    - No MITRE techniques matched
    
    âšª BENIGN - Legitimate Services:
    - Whitelisted (Google, Cloudflare, AWS)
    - Zero detections across all sources
    
    CORRELATION LOGIC:
    - Weight each source appropriately
    - Consider convergence of multiple sources
    - Flag discrepancies (e.g., clean external but SIEM alerts)
    - Note service unavailability (don't penalize missing data)
    
  expected_output: >
    ENHANCED CORRELATION ANALYSIS REPORT
    ========================================
    
    IP: [IP Address]
    ------------------------
    Threat Level: ğŸ”´ CRITICAL / ğŸŸ  HIGH / ğŸŸ¡ MEDIUM / ğŸŸ¢ LOW / âšª BENIGN
    
    Evidence Summary:
    
    External Intelligence:
    - VirusTotal: [X/98 vendors]
    - AbuseIPDB: [X% confidence, Country, ISP]
    - Yeti: [Found/Not Found, tags]
    
    AI-Powered Analysis:
    - ML Classification: [Prediction, XX% confidence]
    - LLM Triage: [Severity, XX% confidence]
    - MITRE Techniques: [T1XXX: Name]
    
    Internal Activity:
    - SIEM Alerts: [X alerts, types]
    
    Correlation Reasoning:
    [Detailed explanation considering ALL sources, explaining
    how each piece of evidence contributes to final verdict]
    
    Confidence: [XX%] (based on source agreement)
    
    Recommended Action:
    [Specific next steps based on threat level]
    
  agent: analyst_agent
  context:
    - task_coordinator
    - task_virustotal_check
    - task_abuseipdb_check
    - task_yeti_check
    - task_siem_query
    - task_ml_classification
    - task_alert_triage
    - task_mitre_context

task_generate_report:
  description: >
    Generate ENHANCED IOC Investigation Report in AnalystDeck AI format
    with microservices enrichment data.
    
    ğŸš¨ CRITICAL RULES (UNCHANGED):
    - Attack Timeline: ONLY use real SIEM alerts (never fabricate)
    - If alerts array is empty: "No alerts found"
    - Copy EXACT timestamps and rule_descriptions
    
    NEW SECTIONS TO INCLUDE:
    
    4. ğŸ¤– AI-Powered Analysis (NEW):
       - ML Classification: [Prediction + confidence]
       - LLM Triage: [Severity + reasoning]
       - MITRE Techniques: [T1XXX: Technique names]
    
    ENHANCED REPORT STRUCTURE:
    
    1. ğŸ”µ IOC Investigation Report header
    2. Verdict: ğŸ’€ Malicious / âœ… Clean
    3. ğŸŒ External Intelligence
       - Location, ISP
       - VirusTotal: X/98
       - AbuseIPDB: X%
       - ğŸ”— Links
    4. ğŸ¤– AI-Powered Analysis (NEW)
       - ML Prediction: [Type, XX%]
       - Triage Severity: [Level, XX%]
       - MITRE Techniques: [T1XXX]
    5. ğŸ¢ Internal Impact
       - SIEM Alerts: âœ…/âš ï¸
       - Affected Assets
    6. â±ï¸ Attack Timeline
       [ONLY real SIEM alerts]
    7. ğŸ“Š Activity Analysis
       [Include ML + LLM insights]
    8. ğŸ¯ Recommended Actions
       [Based on MITRE mitigations]
    9. Footer
    
    TIMELINE RULES (UNCHANGED):
    - Get 'alerts' array from task_siem_query
    - If empty: "No alerts found"
    - If data exists: Use EXACT timestamps/descriptions
    - Show max 10 alerts
    - NEVER invent fake events
    
  expected_output: >
    ğŸ”µ IOC Investigation Report
    Target: [IP]
    
    Verdict: ğŸ’€ Malicious / âœ… Clean
    > [Brief explanation]
    
    ğŸŒ External Intelligence
    ğŸ“ Location: [Country] | ISP: [Name]
    - VirusTotal: X/98 vendors
    - AbuseIPDB: X% confidence
    - Yeti: [Found/Not Found]
    - ğŸ”— [VirusTotal](URL) | [AbuseIPDB](URL)
    
    ğŸ¤– AI-Powered Analysis
    - ML Classification: [Prediction] (XX% confidence)
      â””â”€ Traffic Pattern: [DDoS/PortScan/BruteForce/Benign]
    - LLM Triage: [Severity Level] (XX% confidence)
      â””â”€ Assessment: [LLM reasoning]
    - MITRE ATT&CK:
      â””â”€ T1XXX: [Technique Name]
      â””â”€ T1YYY: [Technique Name]
    
    ğŸ¢ Internal Impact
    - Status: Unknown / Confirmed
    - Affected Assets: [List or None]
    - SIEM Alerts: âœ… No / âš ï¸ YES ([X] alerts)
    
    â±ï¸ Attack Timeline
    [IF alerts exist:]
    YYYY-MM-DD HH:MM:SS - [EXACT rule_description]
    YYYY-MM-DD HH:MM:SS - [EXACT rule_description]
    
    [IF NO alerts:]
    No alerts found in Wazuh SIEM for this IP.
    
    ğŸ“Š Activity Analysis
    [Narrative combining:
     - SIEM timeline (if available)
     - ML behavioral patterns
     - LLM contextual analysis
     - MITRE technique descriptions]
    
    ğŸ¯ Recommended Actions
    - [Action based on MITRE mitigations]
    - [Action based on threat level]
    - [Action based on ML prediction]
    
    ---
    +Generated by AnalystMate at YYYY-MM-DD HH:MM:SS+
    
  agent: reporter_agent
  context:
    - task_coordinator
    - task_virustotal_check
    - task_abuseipdb_check
    - task_yeti_check
    - task_siem_query
    - task_ml_classification
    - task_alert_triage
    - task_mitre_context
    - task_correlation_analysis